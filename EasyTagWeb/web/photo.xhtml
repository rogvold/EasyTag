<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <f:metadata>
        <f:viewAction action="#{userBean.redirectIfNotAuthorized}" />
        <f:viewParam name="id" required="true" value="#{photoBean.photoId}" requiredMessage="PHOTO_ID is required"/>
        <f:viewAction action="#{albumBean.setAlbumId(photoBean.photo.albumId)}" if="#{!empty param['id']}"/>
        <f:viewAction action="#{userBean.setUserId(albumBean.album.creatorId)}" if="#{!empty param['id']}"/>
    </f:metadata>
    <h:body>
        <ui:composition template="templates/main.xhtml">

            <ui:param name="windowTitle" value="Photo - TagsCool"/>
            <ui:param name="user" value="#{currentUserBean.user}"/>
            <ui:param name="loggedIn" value="#{currentUserBean.userId ne null}"/>
            <ui:param name="userProfile" value="#{userBean.userProfile}"/>

            <ui:define name="slider">

            </ui:define>

            <ui:define name="main_content">
                <c:if test="#{photoBean.photo ne null}">
                    <div class="row" style="padding-top: 20px;">

                        <div class="col-lg-12">
                            <div class="col-lg-10" style="padding-left: 0px;">
                                <ol class="breadcrumb">
                                    <li><a href="users.xhtml">All users</a></li>
                                    <li><a href="#{request.contextPath}/userAlbums.xhtml?id=#{userBean.userId}">user #{userBean.userId}</a></li>
                                    <li><a href="#{request.contextPath}/album.xhtml?id=#{albumBean.albumId}">#{albumBean.album.name}</a></li>
                                    <li class="active">#{photoBean.photo.name}</li>
                                </ol>
                            </div>
                            <div class="col-lg-2">
                                <a href="#{request.contextPath}/tagEditor/Editor.html?id=#{photoBean.photoId}" class="btn btn-primary #{userBean.getDisabledClass(userBean.current)}">Редактировать</a>
                            </div>
                        </div>

                    </div>

                    <div class="row">

                        <div class="col-md-9 hs-area">
                            <img class="img-responsive" src="#{request.contextPath}/resources/file/download?id=#{photoBean.photo.fileId}"/>
                        </div>

                        <div class="col-md-3">
                            <h3>#{photoBean.photo.name}</h3>
                            <p>#{photoBean.photo.description}</p>
                            <h3>Tags</h3>
                            <ul id="tagList">
                            </ul>
                            <a href="javascript:void(0);" onclick="toggleTags()" class="btn btn-default">Toggle tags</a>
                        </div>

                    </div>

                    <div class="row">

                        <div class="col-lg-12">
                            <h3 class="page-header">Nearby photo</h3>
                        </div>

                        <div class="col-sm-3 col-xs-6 imageSub">
                            <a href="#{request.contextPath}/photo.xhtml?id=#{photoBean.getPhId(0)}">
                                <img class="img-responsive img-customer" src="#{request.contextPath}/resources/file/download?id=#{photoBean.getPreviewId(0)}"/>
                            </a>
                            <div class="blackbg"></div>
                            <div class="label">#{photoBean.getRelatedPhoto(0).name}</div>
                        </div>

                        <div class="col-sm-3 col-xs-6 imageSub">
                            <a href="#{request.contextPath}/photo.xhtml?id=#{photoBean.getPhId(1)}">
                                <img class="img-responsive img-customer" src="#{request.contextPath}/resources/file/download?id=#{photoBean.getPreviewId(1)}"/>
                            </a>
                            <div class="blackbg"></div>
                            <div class="label">#{photoBean.getRelatedPhoto(1).name}</div>
                        </div>

                        <div class="col-sm-3 col-xs-6 imageSub">
                            <a href="#{request.contextPath}/photo.xhtml?id=#{photoBean.getPhId(2)}">
                                <img class="img-responsive img-customer" src="#{request.contextPath}/resources/file/download?id=#{photoBean.getPreviewId(2)}"/>
                            </a>
                            <div class="blackbg"></div>
                            <div class="label">#{photoBean.getRelatedPhoto(2).name}</div>
                        </div>

                        <div class="col-sm-3 col-xs-6 imageSub">
                            <a href="#{request.contextPath}/photo.xhtml?id=#{photoBean.getPhId(3)}">
                                <img class="img-responsive img-customer" src="#{request.contextPath}/resources/file/download?id=#{photoBean.getPreviewId(3)}"/>
                            </a>
                            <div class="blackbg"></div>
                            <div class="label">#{photoBean.getRelatedPhoto(3).name}</div>
                        </div>

                    </div>
                </c:if>
            </ui:define>

            <ui:define name="main_footer">
                <div class="row">
                    <div class="col-lg-12" onclick="alert(#{photoBean.prevId} + ' ' + #{photoBean.nextId})">
                        <p>Copyright © TagsCool 2013</p>
                    </div>
                </div>
            </ui:define>

            <ui:define name="dialogs">

            </ui:define>

            <ui:define name="scripts">
                <c:if test="#{photoBean.photo ne null}">
                    <style type="text/css">
                        .img-customer {
                            margin-bottom: 0px;
                        }
                    </style>
                    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/css/hotspotter/jquery-hotspotter-1.7.9.min.css" />	
                    <script src="#{request.contextPath}/css/hotspotter/jquery-hotspotter-1.7.9.min.js"></script>
                    <script>
                        //<![CDATA[

                        function appendTag(x, y, w, h, name, id, url) {
                            $('.hs-area').append('<div class="hs-wrap ' + id + '">\n\
                                <div class="red-spot" data-coord="' + x + ',' + y + '" \n\
                                data-dim="' + w + ',' + h + ',0" data-activeon="hover">\n\
                                </div><div class="tt-wrap"><div class="tip-tooltip" data-anim="goin" \n\
                                data-dir="top">' + name + '</div></div></div>');
                            console.log(url);
                            if (!(url === null || url === undefined || url === '')) { // is Url
                                $('.' + id + ' .red-spot').wrap('<a href="' + url + '" target="_blank"></a>');
                            }
                            $('<li/>').text(name).appendTo('#tagList')
                                    .bind('mouseover', function() {
                                        $(this).css('color', 'red');
                                        $('.' + id + ' .red-spot').addClass('active');
                                        $('.' + id + ' .tt-wrap').css('display', 'block');
                                    })
                                    .bind('mouseout', function() {
                                        $(this).css('color', 'black')
                                        $('.' + id + ' .red-spot').removeClass('active')
                                        $('.' + id + ' .tt-wrap').css('display', 'none');
                                    });
                        }

                        function appendTags(pId) {
                            $.ajax({
                                type: "GET",
                                url: "#{request.contextPath}/resources/Tag/getEasyTags?photoId=" + pId,
                                success: function(responseText, statusText) {
                                    if (statusText === 'success') {
                                        console.log(JSON.stringify(responseText));
                                        spots = responseText.data;
                                        for (var i = 0; i < spots.length; i++) {
                                            appendTag(spots[i].x,
                                                    spots[i].y,
                                                    spots[i].width,
                                                    spots[i].height,
                                                    spots[i].name,
                                                    spots[i].id,
                                                    spots[i].externalUrl);
                                        }
                                        $('.hs-area').hotspotter();
                                        $('.hs-wrap').css('left', "+=15"); // hs-area padding
                                    }
                                },
                                dataType: "json"
                            });
                        }

                        function refreshTags() {
                            $('.hs-area .hs-wrap').remove();
                            $('#tagList li').remove();
                            appendTags('#{photoBean.photoId}');
                        }

                        function toggleTags() {
                            $('.hs-area .hs-wrap').toggle();
                        }

                        $(function() {
                            $('.hs-area img').attr('data-imgdim', ["#{photoBean.photo.width}", "#{photoBean.photo.height}"].join(','));
                            refreshTags();
                            $(window).resize(function() {
                                refreshTags();
                            });

                            $(document).bind('keydown', function(e) {
                                if (e.keyCode === 39) {  //right arrow                                    
                                    document.location.href = "#{request.contextPath}/photo.xhtml?id=" + #{photoBean.nextId};
                                }
                                if (e.keyCode === 37) {  //left arrow                                    
                                    document.location.href = "#{request.contextPath}/photo.xhtml?id=" + #{photoBean.prevId};
                                }
                            });

                        });
                        //]]>
                    </script>
                </c:if>
            </ui:define>

        </ui:composition>
    </h:body>

</html>
